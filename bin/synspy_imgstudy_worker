#!/usr/bin/python
#
# Copyright 2015-2017 University of Southern California
# Distributed under the (new) BSD License. See LICENSE.txt for more info.
#

import sys
import synspy
from synspy.worker import coalesce, WorkerRuntimeError

class ImageStudyWorker (synspy.worker.Worker):

    # Image Pair Study state machine:
    # -> Status NULL and N1.Status="processed" and N2.Status="processed"
    # -> Status="processing..." (claimed to generate alignment)
    #    -> Status="aligned" (alignment complete)
    #       Alignment set
    #       Region 1 URL set
    #       Region 2 URL set
    # *-> Status={"failed": "reason"}

    get_claimable_work_url = '/attribute/S:=Image%20Pair%20Study/Status::null::;Status=null/N1:=(Nucleic%20Region%201)/Status=%22processed%22/$S/N2:=(Nucleic%20Region%202)/Status=%22processed%22/$S/*,N1_URL:=N1:Segments%20Filtered%20URL,N2_URL:=N2:Segments%20Filtered%20URL?limit=1'
    put_claim_url = '/attributegroup/Zebrafish:Image%20Pair%20Study/ID;Status'
    put_row_update_baseurl = '/attributegroup/Zebrafish:Image%20Pair%20Study/ID'

    def run_row_job(self):
        try:
            M, n1_url, n2_url = self.register_nuclei(self.row['N1_URL'], self.row['N2_URL'])
            updated_row = {
                'ID': self.row['ID'],
                'Alignment': self.matrix_to_prejson(M),
                'Region 1 URL': n1_url,
                'Region 2 URL': n2_url,
                'Status': "aligned"
            }
            self.put_row_update(updated_row)
            sys.stderr.write('Processing complete.\n')
        finally:
            self.cleanup()

ImageStudyWorker.blocking_poll()
